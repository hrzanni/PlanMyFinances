{% extends 'base.html' %} {% block body %}
<div class="content">
    <h1 class="name">PlanMyFinances</h1>

    <div class="home-top-container">
      <div class="add-container">
        <div class="add">
          <h3>Adicionar Receita</h3>
          <button id="add-button-revenue" class="add-button-green">+</button>
          <p>Clique para adicionar uma receita</p>
        </div>

        <div class="add">
          <h3>Adicionar Despesa</h3>
          <button id="add-button-expense" class="add-button-red">+</button>
          <p>Clique para adicionar uma despesa</p>
        </div>
      </div>

      <div class="recentSummary">
        <table class="transaction-table">
          <h3>5 últimas Movimentações</h3>
          <thead>
            <tr>
              <th>Descrição</th>
              <th>Tipo</th>
              <th>Subtipo</th>
              <th>Data</th>
              <th>Valor</th>
            </tr>
          </thead>
          <tbody>
            {% for m in movimentacoes %}
              <tr class="{{ 'receita' if m.categoria == 'receita' else 'despesa' }}">
                <td>{{ m.descricao }}</td>
                <td>{{ m.tipo }}</td>
                <td>{{ m.subtipo }}</td>
                <td>{{ m.data }}</td>
                <td>R$ {{ m.valor }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
  </div>

    <div id="add-button-revenue-form" class="modal-overlay" style="display: none">
        <div class="modal-content">
            <button id="close-modal" class="close-button">×</button>
            <form action="/add-revenue" method="POST">
                <h1>ADICIONAR RECEITA</h1>
                <label for="valor">Valor:</label>
                <input type="number" name="valor" step="0.01" required><br>

                <label for="descricao">Descrição:</label>
                <input type="text" name="descricao" required><br>

                <label for="tipo">Tipo:</label>
                <select name="tipo" id="tipo-select-receita" required>
                  <option value="" disabled selected>Escolha um tipo</option>
                  {% for tipo in tipos_disponiveis %}
                    <option value="{{ tipo|lower }}">{{ tipo }}</option>
                  {% endfor %}
                </select><br>

                <label for="subtipo">Subtipo(opcional):</label>
                <select name="subtipo" id="subtipo-select-receita">
                  {% for subtipo in subtipos_disponiveis %}
                    <option value="" disabled selected>Escolha um subtipo</option>              
                  {% endfor %}
                </select><br>

                <label for="data">Data:</label>
                <input type="date" name="data" id="data-input" required><br>

                <button type="submit">Salvar</button>
            </form>
        </div>
    </div>

    <div id="add-button-expense-form" class="modal-overlay" style="display: none;">
        <div class="modal-content">
          <button id="close-expense-modal" class="close-button">×</button>
          <form action="/add-expense" method="POST">
            <h1>ADICIONAR DESPESA</h1>
            <label for="valor">Valor:</label>
            <input type="number" name="valor" step="0.01" required><br>
      
            <label for="descricao">Descrição:</label>
            <input type="text" name="descricao" required><br>
            
            <label for="tipo">Tipo:</label>
                <select name="tipo" id="tipo-select-despesa" required>
                  <option value="" disabled selected>Escolha um tipo</option>
                  {% for tipo in tipos_disponiveis %}
                    <option value="{{ tipo|lower }}">{{ tipo }}</option>
                  {% endfor %}
                </select><br>

                <label for="subtipo">Subtipo(opcional):</label>
                <select name="subtipo" id="subtipo-select-despesa">
                  {% for subtipo in subtipos_disponiveis %}
                  <option value="" disabled selected>Escolha um subtipo</option> 
                  {% endfor %}
                </select><br>

      
            <label for="data">Data:</label>
            <input type="date" name="data" id="data-expense-input" required><br>
      
            <button type="submit">Salvar</button>
          </form>
        </div>
      </div>

    <div class="add-typeANDSubtype">
        <h2>Gerenciador de Tipos e <br>SubTipos</h2>
        <div class="add-typeANDSubtype-type">
            <form action="/add-type" method="POST">
                <input type="text" name="tipos" placeholder="Adicione um tipo" required>
                <button class="add-type-button" type="submit">+</button>
            </form>
            <table class="styled-table">
                <thead>
                  <tr>
                    <th>Tipos criados</th>
                  </tr>
                </thead>
                <tbody>
                  {% for item in tipos_disponiveis %}
                    <tr>
                      <td>{{ item }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
        </div>

        <div class="add-typeANDSubtype-subtype">
            <form action="/add-subtype" method="POST">
                <input type="text" name="subtipos" placeholder="Adicione um subtipo" required>
                
                <select name="tipo_relacionado" required">
                  <option value="" disabled selected>Selecione o tipo</option>
                  {% for tipo in tipos_disponiveis %}
                    <option value="{{ tipo }}">{{ tipo }}</option>
                  {% endfor %}
                </select>

                <button class="add-subtype-button" type="submit">+</button>
            </form>
            <table class="styled-table">
                <thead>
                  <tr>
                    <th>Subtipos criados</th>
                    <th>Tipo relacionado</th>
                  </tr>
                </thead>
                <tbody>
                  {% for subtipo, tipo in subtipos_por_tipo.items() %}
                    {% for st in tipo %}
                      <tr>
                        <td>{{ st }}</td>
                        <td>{{ subtipo }}</td>
                      </tr>
                    {% endfor %}
                  {% endfor %}
                </tbody>
              </table>
        </div>
        
    </div>
    
    <script>
      const subtiposPorTipo = {{ subtipos_por_tipo | tojson }};
    
      function configurarSelects(tipoId, subtipoId) {
        const tipoSelect = document.getElementById(tipoId);
        const subtipoSelect = document.getElementById(subtipoId);
    
        if (!tipoSelect || !subtipoSelect) return;
    
        tipoSelect.addEventListener('change', () => {
          const tipoSelecionado = tipoSelect.value;
          const subtipos = subtiposPorTipo[tipoSelecionado] || [];
    
          // Limpa e adiciona a primeira opção
          subtipoSelect.innerHTML = '<option value="" disabled selected>Escolha um subtipo</option>';
    
          subtipos.forEach(subtipo => {
            const option = document.createElement('option');
            option.value = subtipo;
            option.textContent = subtipo;
            subtipoSelect.appendChild(option);
          });
    
          subtipoSelect.disabled = subtipos.length === 0;
        });
      }
    
      // Aplica a função nos dois formulários
      configurarSelects('tipo-select-receita', 'subtipo-select-receita');
      configurarSelects('tipo-select-despesa', 'subtipo-select-despesa');
    </script>

    <script>
        // Receita
        const openRevenueBtn = document.getElementById("add-button-revenue");
        const revenueModal = document.getElementById("add-button-revenue-form");
        const closeRevenueBtn = document.getElementById("close-modal");
      
        openRevenueBtn.addEventListener("click", () => {
          revenueModal.style.display = "flex";
          const today = new Date().toISOString().split("T")[0];
          document.getElementById("data-input").value = today;
        });
      
        closeRevenueBtn.addEventListener("click", () => {
          revenueModal.style.display = "none";
        });
      
        window.addEventListener("click", (e) => {
          if (e.target === revenueModal) {
            revenueModal.style.display = "none";
          }
        });
      
        // Despesa
        const openExpenseBtn = document.getElementById("add-button-expense");
        const expenseModal = document.getElementById("add-button-expense-form");
        const closeExpenseBtn = document.getElementById("close-expense-modal");
      
        openExpenseBtn.addEventListener("click", () => {
          expenseModal.style.display = "flex";
          const today = new Date().toISOString().split("T")[0];
          document.getElementById("data-expense-input").value = today;
        });
      
        closeExpenseBtn.addEventListener("click", () => {
          expenseModal.style.display = "none";
        });
      
        window.addEventListener("click", (e) => {
          if (e.target === expenseModal) {
            expenseModal.style.display = "none";
          }
        });
      </script>
</div>
{% endblock %}
